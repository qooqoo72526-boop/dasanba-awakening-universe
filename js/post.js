
const avatars={ajin:'assets/icon_ajin.png',migou:'assets/icon_migou.png',gungun:'assets/icon_gungun.png',you:'assets/icon_you.png'};
function addMsg(who,text,typing=false){const wrap=document.getElementById('chat');const row=document.createElement('div');row.className='msg '+(who==='you'?'you':'');const av=document.createElement('img');av.src=avatars[who]||avatars.ajin;av.className='avatar';const b=document.createElement('div');b.className='bubble';b.innerHTML=typing?`<span class="typing"></span>`:text;row.appendChild(av);row.appendChild(b);wrap.appendChild(row);wrap.scrollTop=wrap.scrollHeight+999;return{row,b};}
function sequenceReplies(text){const birds=['ajin','migou','gungun'];let i=0;function step(){if(i>=birds.length)return;const who=birds[(Math.random()<.4?0:(Math.random()<.5?1:2))];const{b}=addMsg(who,'',true);setTimeout(async()=>{try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o-mini',temperature:0.9,messages:[{role:'system',content:`你是「大三巴覺醒宇宙」中的一位朋友。語氣口語、不官方。句子只用逗號、句號、驚嘆號，能用表情符號。阿金=自由反骨，米果=自我價值與邊界，高傲不溫柔，滾滾=理解與共鳴。`},{role:'user',content:text}]})});const data=await r.json();const content=data?.choices?.[0]?.message?.content||'收到啦！';b.innerHTML=content;}catch(e){b.innerHTML='星訊有點塞車，等等我！';}i++;setTimeout(step,600+Math.random()*800);},500+Math.random()*800);}step();}
document.addEventListener('DOMContentLoaded',()=>{const chat=document.getElementById('chat');const inputWrap=document.createElement('div');inputWrap.style='display:flex;gap:8px;margin-top:14px;';const input=document.createElement('input');input.type='text';input.placeholder='在星際隧道投遞一句話，按 Enter 傳訊⋯';input.style='flex:1;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#fff;';const send=document.createElement('button');send.className='btn';send.innerText='➤';inputWrap.appendChild(input);inputWrap.appendChild(send);chat.appendChild(inputWrap);function sendNow(){const v=input.value.trim();if(!v)return;addMsg('you',v,false);input.value='';sequenceReplies(v);}input.addEventListener('keydown',e=>{if(e.key==='Enter'){sendNow();}});send.addEventListener('click',sendNow);});
